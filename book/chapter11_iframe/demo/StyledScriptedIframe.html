<script type="module">
  function makeFrame(node, hrefOrSrc) {
    const clone = node.cloneNode(false);
    const src = clone.getAttribute(hrefOrSrc);
    if (src)
      clone.setAttribute(hrefOrSrc, new URL(src, document.baseURI).href);
    return clone.outerHTML;
  }

  function transposeTag(node) {
    if (!node)
      return "";                        //todo throw a warning here?
    let tagName = node.tagName.toLowerCase();
    if (tagName.startsWith("iframe-"))
      tagName = tagName.substr(7);
    let hrefOrSrc = undefined;
    if (tagName === "script")
      hrefOrSrc = "src";
    else if (tagName === "link")
      hrefOrSrc = "href";

    let frame = makeFrame(node, hrefOrSrc);
    frame = "<" + tagName + frame.substr(node.tagName.length + 1);
    const endTagStart = frame.lastIndexOf("</");
    if (endTagStart !== -1)
      frame = frame.substr(0, endTagStart);
    return frame + node.innerHTML + "</" + tagName + ">";
  }

  class StyledScriptedIframe extends HTMLElement {
    constructor() {
      super();
      this.attachShadow({mode: "open"});
      this.shadowRoot.appendChild(document.createElement("iframe"));
      this._iframe = this.shadowRoot.children[0];
      this._iframe.setAttribute("sandbox", "allow-scripts");
    }

    static get observedAttributes() {
      return ["srcdoc"];
    }

    attributeChangedCallback(name, oldValue, newValue) {
      if (name === "srcdoc") {
        const resources = this.getOuterIncluded().concat(this.getInnerIncluded());
        debugger;
        let src = resources.map(child => transposeTag(child)).join("");
        this._iframe.setAttribute("srcdoc", src + (newValue || ""));
      }
    }

    getInnerIncluded() {
      return Array.from(this.children).filter(n => n.tagName === "IFRAME-SCRIPT" || n.tagName === "IFRAME-STYLE" || n.tagName === "IFRAME-LINK");
    }

    getOuterIncluded() {
      return this.getAttribute("included-resources").split(" ").map(selector => document.querySelector(selector));
    }
  }

  customElements.define("iframe-styled-scripted", StyledScriptedIframe);

</script>
<header-one>Hello<br>sunshine!</header-one>
<hr>
<style id="alpha">
  header-one {
    color: red;
  }
</style>
<style id="beta">
  header-one {
    background-color: pink;
  }
</style>
<link id="uno" rel="stylesheet" href="styledIframe.css">
<script id="one">
  class HeaderOne extends HTMLElement {
    constructor() {
      super();
      this.attachShadow({mode: "open"});
      this.shadowRoot.innerHTML = "<style>slot {font-weight: bold; font-size: 2em;}</style><slot></slot>"
    }
  }

  customElements.define("header-one", HeaderOne);
  console.log("script1"); //should print twice
</script>
<script id="two">
  console.log("script2");
</script>

<iframe-styled-scripted
    included-resources="script#one script#three style#alpha link#uno"
    srcdoc="<header-one>Hello<br>sunshine!</header-one>">
  <iframe-style>
    header-one {
    border-bottom: 4px dotted blue;
    }
  </iframe-style>
  <iframe-script src="scriptedIframe.js">
    exclude me
  </iframe-script>
  <iframe-script>
    console.log("iframe-script says hi!");
  </iframe-script>
</iframe-styled-scripted>

<!--
  This code is untested. I have only done superficial tests from within devtools in Chrome.
  The code should only work in Chrome, Safari, Firefox as template does not work in IE and Edge.
-->