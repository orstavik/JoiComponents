<script type="module">
  function makeAttributeLinksAbs(node) {
    let res = "";
    for (let i = 0; i < node.attributes.length; i++) {
      let att = node.attributes[i];
      const v = (att.name === "href" || att.name === "src") ? new URL(att.value, document.baseURI).href : att.value;
      res += " " + att.name + '="' + v + '"';
    }
    return res;
  }

  function transposeTag(node) {
    if (!node)
      return "";                        //todo throw a warning here?
    let tagName = node.tagName.toLowerCase();
    if (tagName.startsWith("iframe-"))
      tagName = tagName.substr(7);

    let frame = makeAttributeLinksAbs(node);
    return "<" + tagName + frame + ">" + node.innerHTML + "</" + tagName + ">";
  }

  class StyledScriptedIframe extends HTMLElement {
    constructor() {
      super();
      this.attachShadow({mode: "open"});
      this.shadowRoot.appendChild(document.createElement("iframe"));
      this._iframe = this.shadowRoot.children[0];
      this._iframe.setAttribute("sandbox", "allow-scripts");
    }

    static get observedAttributes() {
      return ["srcdoc"];
    }

    attributeChangedCallback(name, oldValue, newValue) {
      if (name === "srcdoc") {
        const resources = this.getOuterIncluded().concat(this.getInnerIncluded());
        let srcs = resources.map(child => transposeTag(child));
        this._iframe.setAttribute("srcdoc", srcs.join("") + (newValue || ""));
      }
    }

    getInnerIncluded() {
      return Array.from(this.children).filter(n => n.tagName === "IFRAME-SCRIPT" || n.tagName === "IFRAME-STYLE" || n.tagName === "IFRAME-LINK");
    }

    getOuterIncluded() {
      return this.getAttribute("included-resources").split(" ").map(selector => document.querySelector(selector));
    }
  }

  customElements.define("iframe-styled-scripted", StyledScriptedIframe);

</script>
<header-one>Hello<br>sunshine!</header-one>
<hr>
<style id="alpha">
  header-one {
    color: red;
  }
</style>
<style id="beta">
  header-one {
    background-color: pink;
  }
</style>
<link id="uno" rel="stylesheet" href="styledIframe.css">
<script id="one">
  class HeaderOne extends HTMLElement {
    constructor() {
      super();
      this.attachShadow({mode: "open"});
      this.shadowRoot.innerHTML = "<style>slot {font-weight: bold; font-size: 2em;}</style><slot></slot>"
    }
  }

  customElements.define("header-one", HeaderOne);
  console.log("script1"); //should print twice
</script>
<script id="two">
  console.log("script2");
</script>

<iframe-styled-scripted
    included-resources="script#one script#three style#alpha link#uno"
    srcdoc="<header-one>Hello<br>sunshine!</header-one>">
  <iframe-style>
    header-one {
    border-bottom: 4px dotted blue;
    }
  </iframe-style>
  <iframe-script src="scriptedIframe.js">
    exclude me
  </iframe-script>
  <iframe-script>
    console.log("iframe-script says hi!");
  </iframe-script>
</iframe-styled-scripted>

<!--
  This code is untested. I have only done superficial tests from within devtools in Chrome.
  The code should only work in Chrome, Safari, Firefox as template does not work in IE and Edge.
-->